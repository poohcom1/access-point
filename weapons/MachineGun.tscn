[gd_scene load_steps=6 format=2]

[ext_resource path="res://assets/SE/MachineGun2.mp3" type="AudioStream" id=1]
[ext_resource path="res://assets/SE/Ricochet1.mp3" type="AudioStream" id=2]
[ext_resource path="res://assets/SE/Ricochet2.mp3" type="AudioStream" id=3]
[ext_resource path="res://assets/ui/crosshairs/crosshair010.png" type="Texture" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Weapon

export var SHOOT_INTERVAL := 0.05
export var DAMAGE = 1
export var KNOCKBACK = 5

export var RAMP_UP_DAMAGE = 4
export var RAMP_UP_FRAMES = 30
export var AOE = false

# Fields
var wall_hit := false
var shooting = false

var hit_targets := {} # For damage rampup

# Nodes
const ShootArea = preload(\"res://weapons/objects/ShootArea.tscn\")
const CrossHair = preload(\"res://ui/CrossHair.tscn\")
var cross_hair_ref := WeakRef.new()

var shoot_collider: Area2D

onready var line_of_sight := $LineOfSight
onready var shoot_interval := Timer.new()

func _ready():
	## Timer
	
	# warning-ignore:return_value_discarded
	shoot_interval.connect(\"timeout\", self, \"_on_shoot\")
	add_child(shoot_interval)
	
	## Hit-scan
	shoot_collider = ShootArea.instance()
	add_child(shoot_collider)
	
	## Name
	weapon_name = \"Submachine-gun\"


func _on_shoot():		
	shoot_collider.shoot()
		
	ammo -= 1
	
	var enemies = shoot_collider.get_overlapping_bodies()
	
	var nearest = get_nearest_enemy(enemies)
	
	# Clear targets marked for rampup
	for target in hit_targets:
		hit_targets[target].hit = false
	
	if nearest != null and nearest.health > 0:
		damage_enemy(nearest, 4)
		var cross_hair = cross_hair_ref.get_ref()
		
		if not cross_hair:
			cross_hair = CrossHair.instance()
			cross_hair_ref = weakref(cross_hair)
			
		cross_hair.attach_to_parent(nearest)
		
			
				
	if AOE: 
		for body in enemies:
			if body is Enemy and body != nearest:
				damage_enemy(body)
	
	# Erase target not marked
	for target in hit_targets:
		if not hit_targets[target].hit:
			# warning-ignore:return_value_discarded
			hit_targets.erase(target)
			
			var cross_hair = cross_hair_ref.get_ref()
			
			if cross_hair:
				var current_target = cross_hair.parent_ref.get_ref()
				if current_target and current_target == target:
					cross_hair.detach()
				
func damage_enemy(enemy: Enemy, rampup=1):
	var damage = DAMAGE
	
	## Rampup system
	if not hit_targets.has(enemy):
		hit_targets[enemy] = {
			\"frames\": 1,
			\"hit\": true
		}
	else:
		hit_targets[enemy].frames += rampup
		hit_targets[enemy].hit = true
		
		damage = floor(lerp(
			DAMAGE, 
			RAMP_UP_DAMAGE, 
			min(hit_targets[enemy][\"frames\"], RAMP_UP_FRAMES)/float(RAMP_UP_FRAMES)
			))
	
	enemy.on_hit(damage)
	enemy.on_hit_knockback( 
		global_position.direction_to(enemy.global_position) * KNOCKBACK,
		0.02
		 )
		
func get_nearest_enemy(bodies):
	var nearest_enemy = null
	var nearest_distance = INF
	
	for body in bodies:
		if body is Enemy:
			var distance = body.global_position.distance_to(get_global_mouse_position())
			if distance < nearest_distance:
				nearest_enemy = body
				nearest_distance = distance
			
	return nearest_enemy

func on_active():
	if Input.is_action_pressed(\"shoot\") and ammo > 0:
		line_of_sight.cast_to = (get_global_mouse_position() - global_position)
	
		# Check for wall hits
		if line_of_sight.is_colliding() and line_of_sight.get_collider() is TileMap:
			var offset = Vector2.ZERO
			
			if line_of_sight.get_collision_normal().y < 0:
				offset += line_of_sight.get_collision_normal() * 8
			
			shoot_collider.global_position = line_of_sight.get_collision_point() + offset
		else:
			# No wall hit
			shoot_collider.global_position = get_global_mouse_position()
			
		if Input.is_action_just_pressed(\"shoot\"):
			on_switch()
			
		shooting = true
			
		#shoot_collider.get_node(\"Particles\").emitting = true
	else:
		if shooting:
			if cross_hair_ref.get_ref():
				cross_hair_ref.get_ref().detach()
			on_switch_out()
			shooting = false

func on_switch():
	shoot_interval.start(SHOOT_INTERVAL)
	_on_shoot()
		
	if not $GunSE.playing:
		$GunSE.play()
	shooting = true

func on_switch_out():
	$GunSE.stop()
	
	# Ricochet SFX
	if ammo > 0:
		# 10% chance to play
		match randi() % 10:
			1: $Ricochet1.play()
			2: $Ricochet2.play()
	
	hit_targets.clear()
	shoot_interval.stop()
	if cross_hair_ref.get_ref():
		cross_hair_ref.get_ref().detach()

		
		
"

[node name="MachineGun" type="Node2D"]
script = SubResource( 1 )
MAX_AMMO = 1000
CROSS_HAIR = ExtResource( 4 )
KNOCKBACK = 0
RAMP_UP_DAMAGE = 6
RAMP_UP_FRAMES = 40
AOE = true

[node name="LineOfSight" type="RayCast2D" parent="."]
enabled = true
collision_mask = 524288

[node name="GunSE" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource( 1 )
volume_db = -5.047

[node name="Ricochet1" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource( 2 )
volume_db = -15.389

[node name="Ricochet2" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource( 3 )
volume_db = -17.0
